version: 2.1

orbs:
  go: circleci/go@1.2

workflows:
  main:
    jobs:
      - test-on-linux
      - test-on-macos
      - release-on-linux
      - release-on-macos
  release:
    jobs:
      - test-on-linux:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v\d+\.\d+\.\d+$/
      - test-on-macos:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v\d+\.\d+\.\d+$/
      - release-on-linux:
          requires:
            - test-on-linux
          context: main-context
      - release-on-macos:
          requires:
            - test-on-macos
            - release-on-linux
          context: main-context

jobs:
  test-on-linux:
    machine:
      image: ubuntu-1604:202004-01
    working_directory: "~/gotham"
    steps:
      - checkout
      - go/install:
          version: 1.14.4
      - run:
          name: "Install Mage"
          command: |
            curl -sSL "https://github.com/magefile/mage/releases/download/v1.9.0/mage_1.9.0_Linux-64bit.tar.gz" | sudo tar -xz --no-same-owner -C /usr/local/bin mage
            mage --version
      - go/load-cache
      - restore_cache:
          key: "go-test-cache-v1-{{ arch }}"
      - run:
          name: "Pull & Verify Dependencies"
          command: |
            go mod download
            go mod verify
      - run:
          name: "Mage Test"
          command: mage -v test
      - run:
          name: "Mage Check"
          command: mage -v check
      - go/save-cache
      - save_cache:
          key: "go-test-cache-v1-{{ arch }}"
          paths:
            - "/home/circleci/.cache/go-build"
      - run:
          name: "Build Binary"
          command: |
            mage -v gotham
            ./gotham version
  test-on-macos:
    macos:
      xcode: 11.5.0
    environment:
      HUGO_BUILD_TAGS: "extended"
      GO111MODULE: "on"
    working_directory: "~/gotham"
    steps:
      - checkout
      # https://github.com/CircleCI-Public/go-orb/issues/37
      - run:
          name: "Install Go"
          command: brew install go
      - run:
          name: "Install Mage"
          command: |
            curl -sSL "https://github.com/magefile/mage/releases/download/v1.9.0/mage_1.9.0_macOS-64bit.tar.gz" | sudo tar -xz --no-same-owner -C /usr/local/bin mage
            mage --version
      - go/load-cache
      - restore_cache:
          key: "go-test-cache-v3-{{ arch }}"
      - run:
          name: "Pull & Verify Dependencies"
          command: |
            go mod download
            go mod verify
      - run:
          name: "Mage Test"
          command: mage -v test
      - run:
          name: "Mage Check"
          command: mage -v check
      - go/save-cache
      - save_cache:
          key: "go-test-cache-v3-{{ arch }}"
          paths:
            - "/Users/distiller/Library/Caches/go-build"
      - run:
          name: "Build Binary"
          command: |
            mage -v gotham
            ./gotham version
  release-on-linux:
    machine:
      image: ubuntu-1604:202004-01
    working_directory: "~/gotham"
    steps:
      - checkout
      - go/install:
          version: 1.14.4
      - run:
          name: "Install GoReleaser"
          command: |
            curl -sSL "https://github.com/goreleaser/goreleaser/releases/download/v0.137.0/goreleaser_Linux_x86_64.tar.gz" | sudo tar -xz -C /usr/local/bin goreleaser
            goreleaser --version
      - run:
          name: "Build Snapshot or Release"
          command: |
            if [[ $CIRCLE_TAG == "" ]]; then
              goreleaser release --config=.goreleaser.linux.yml --snapshot --skip-publish
            else
              goreleaser release --config=.goreleaser.linux.yml
            fi

            echo "Some information about this binary built by GoReleaser:"
            echo "======================================================="
            ls -lah dist/*/gotham
            dist/*/gotham version --type=detailed
  release-on-macos:
    macos:
      xcode: 11.5.0
    working_directory: "~/gotham"
    steps:
      - checkout
      # https://github.com/CircleCI-Public/go-orb/issues/37
      - run:
          name: "Install Go"
          command: brew install go
      - run:
          name: "Install GoReleaser"
          command: |
            curl -sSL "https://github.com/goreleaser/goreleaser/releases/download/v0.137.0/goreleaser_Darwin_x86_64.tar.gz" | sudo tar -xz -C /usr/local/bin goreleaser
            goreleaser --version
      - run:
          name: "Build Snapshot or Release"
          command: |
            if [[ $CIRCLE_TAG == "" ]]; then
              goreleaser release --config=.goreleaser.macos.yml --snapshot --skip-publish
            else
              goreleaser release --config=.goreleaser.macos.yml
            fi

            echo "Some information about this binary built by GoReleaser:"
            echo "======================================================="
            ls -lah dist/*/gotham
            dist/*/gotham version --type=detailed
