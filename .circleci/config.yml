version: 2.1

orbs:
  go: circleci/go@1.2

defaults: &defaults
  docker:
      - image: bepsays/ci-goreleaser:1.14.3
  environment:
    CGO_ENABLED: "0"

workflows:
  main:
    jobs:
      - test
  release:
      jobs:  
        - build:
            filters:
              branches:
                only: /release-.*/
        - hold:
            type: approval
            requires:
              - build
        - release:
            context: org-global
            requires:
              - hold
jobs:
  test:
    machine:
      image: ubuntu-1604:202004-01
    environment:
      #CGO_ENABLED: "1"
      HUGO_BUILD_TAGS: "extended"
      GO111MODULE: "on"
    working_directory: "~/gotham"
    steps:
      - checkout
      - go/install:
          version: 1.14.3
      - run:
          name: "Install Mage"
          command: |
            curl -sSL "https://github.com/magefile/mage/releases/download/v1.9.0/mage_1.9.0_Linux-64bit.tar.gz" | sudo tar -xz --no-same-owner -C /usr/local/bin mage
            mage --version
      - run:
          name: "Pull & Verify Dependencies"
          command: |
            go mod download
            go mod verify
      - run:
          name: "Mage Test"
          command: mage -v test
      - run:
          name: "Mage Check"
          command: mage -v check
      - run:
          name: "Build Binary"
          command: |
            mage -v gotham
            ./gotham version
  build:
    <<: *defaults
    steps:
      - checkout:
          path: hugo
      - run:
            command: |
                git clone git@github.com:gohugoio/hugoDocs.git
                cd hugo
                go mod download
                sleep 5
                go mod verify
                go test -p 1 ./...
      - persist_to_workspace:
          root: .
          paths: .
  release:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /root/project
      - run:
            command: |
                    cd hugo
                    git config --global user.email "bjorn.erik.pedersen+hugoreleaser@gmail.com"
                    git config --global user.name "hugoreleaser"
                    go run -tags release main.go release -r ${CIRCLE_BRANCH}
